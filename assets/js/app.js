/**
 * Main Application
 * Orchestrates all components
 */

class App {
	constructor() {
		this.initialized = false;
	}

	async init() {
		if (this.initialized) return;

		try {
			router.init();
			this.setupBackToTop();
			this.setupDrawer(); // NEW
			this.initialized = true;
		} catch (error) {
			console.error('App initialization error:', error);
		}
	}

	setupBackToTop() {
		const backToTopBtn = document.getElementById('backToTopBtn');
		if (!backToTopBtn) return;

		const toggle = () => {
			backToTopBtn.classList.toggle('visible', window.scrollY > 320);
		};

		window.addEventListener('scroll', toggle);
		backToTopBtn.addEventListener('click', () => {
			window.scrollTo({ top: 0, behavior: 'smooth' });
		});
		toggle();
	}

	/**
	 * Mobile drawer (hamburger menu)
	 */
	setupDrawer() {
		const menuBtn = document.getElementById('menuBtn');
		const drawer = document.getElementById('mobileDrawer');
		const backdrop = document.getElementById('drawerBackdrop');
		const closeBtn = document.getElementById('drawerCloseBtn');

		// Drawer is optional; do nothing if elements aren't present.
		if (!menuBtn || !drawer || !backdrop || !closeBtn) return;

		const openDrawer = () => {
			drawer.classList.add('open');
			backdrop.hidden = false;

			drawer.setAttribute('aria-hidden', 'false');
			menuBtn.setAttribute('aria-expanded', 'true');
			document.body.classList.add('no-scroll');
		};

		const closeDrawer = () => {
			drawer.classList.remove('open');
			backdrop.hidden = true;

			drawer.setAttribute('aria-hidden', 'true');
			menuBtn.setAttribute('aria-expanded', 'false');
			document.body.classList.remove('no-scroll');
		};

		menuBtn.addEventListener('click', () => {
			const isOpen = drawer.classList.contains('open');
			if (isOpen) closeDrawer();
			else openDrawer();
		});

		closeBtn.addEventListener('click', closeDrawer);
		backdrop.addEventListener('click', closeDrawer);

		window.addEventListener('keydown', (e) => {
			if (e.key === 'Escape') closeDrawer();
		});

		// Close drawer when clicking any navigation link or chapter inside it.
		drawer.addEventListener('click', (e) => {
			const target = e.target;
			if (!(target instanceof Element)) return;

			const link = target.closest('a, button');
			if (!link) return;

			// Close on:
			// - the drawer nav links (Guide/Troubleshooting/Changelog)
			// - chapter buttons generated by pages.js (.guide-link)
			if (
				link.matches('a[href^="#/"]') ||
				link.classList.contains('guide-link')
			) {
				closeDrawer();
			}
		});

		// Make close function available (optional) for other scripts.
		window.__revo_closeDrawer = closeDrawer;
	}
}

const app = new App();

if (document.readyState === 'loading') {
	document.addEventListener('DOMContentLoaded', () => app.init());
} else {
	app.init();
}
